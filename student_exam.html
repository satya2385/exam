<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Student Exam</title>
    <link rel="stylesheet" href="styles.css" />

        <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #eef3f7;
        padding: 25px;
        color: #222;
      }

      h2 {
        font-size: 26px;
        color: #0d47a1;
        font-weight: 600;
        margin-bottom: 10px;
      }

      /* Logout button */
      button {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, #1976d2, #0d47a1);
        color: #fff;
        font-size: 15px;
        transition: 0.2s ease-in-out;
      }
      button:hover {
        transform: scale(1.05);
        opacity: 0.95;
      }

      /* Main exam box */
      #examContainer {
        background: #fff;
        padding: 25px;
        border-radius: 14px;
        max-width: 850px;
        margin: 20px auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        animation: fadeIn 0.35s ease-in-out;
      }

      h3 {
        color: #0d47a1;
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      #timer {
        font-size: 20px;
        font-weight: bold;
        color: #d32f2f;
      }

      /* Questions area */
      #examForm {
        margin-top: 20px;
        font-size: 18px;
        line-height: 1.6;
      }

      #examForm b {
        color: #333;
        font-size: 20px;
      }

      label {
        display: block;
        background: #f3f8ff;
        border: 1px solid #cfd8dc;
        padding: 10px 14px;
        margin: 10px 0;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s ease-in-out;
      }

      label:hover {
        background: #e3f2fd;
        border-color: #90caf9;
      }

      /* Navigation Buttons */
      #examForm button {
        margin-top: 20px;
        padding: 10px 20px;
        background: #1976d2;
        border-radius: 8px;
        font-size: 15px;
      }

      #examForm button:nth-child(2) {
        background: #455a64;
      }

      #msg h3 {
        font-size: 26px;
        color: #388e3c;
        margin-bottom: 10px;
      }

      /* Result text */
      #msg p {
        font-size: 20px;
        font-weight: 600;
      }

      /* Smooth fade animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive */
      @media (max-width: 600px) {
        body {
          padding: 15px;
        }
        #examContainer {
          padding: 18px;
        }
        label {
          font-size: 16px;
        }
        button {
          width: 100%;
          margin: 6px 0;
        }
      }
    </style>
  </head>

  <body>
    <h2>Welcome, <span id="userName"></span></h2>
    <button onclick="logoutUser()">Logout</button>
    <hr />

    <div id="examContainer">
      <h3>Aptitude Exam</h3>
      <p>Time Remaining: <span id="timer">00:00</span></p>
      <form id="examForm"></form>
      <p id="msg"></p>
    </div>

    <script type="module">
      import { db } from "./firebase.js";
      import {
        collection,
        getDocs,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

      const stuName = localStorage.getItem("studentName");
      const stuRoll = localStorage.getItem("roll");
      const loginId = localStorage.getItem("loginId");

      if (!stuName || !stuRoll || !loginId) {
        alert("Login first!");
        window.location.href = "login.html";
      }

      document.getElementById("userName").innerText = stuName + " (Student)";

      window.logoutUser = () => {
        localStorage.clear();
        window.location.href = "login.html";
      };

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      /* ---------------------------------------------------
         DAILY LIMIT CHECK (ONLY ONE EXAM PER DAY)
      ----------------------------------------------------*/
      async function checkDailyLimit() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const snap = await getDocs(collection(db, "results"));

        let alreadyGiven = false;

        snap.forEach((d) => {
          const r = d.data();
          if (r.loginId === loginId && r.testType === "Aptitude Test") {
            const t = r.timestamp?.toDate
              ? r.timestamp.toDate()
              : new Date(r.timestamp.seconds * 1000);

            t.setHours(0, 0, 0, 0);

            if (t.getTime() === today.getTime()) {
              alreadyGiven = true;
            }
          }
        });

        if (alreadyGiven) {
          document.getElementById("examContainer").innerHTML = `
            <h3 style="color:red;">You have already taken today's exam.</h3>
            <p>Please try again tomorrow.</p>
          `;
          return false;
        }

        return true;
      }

      /* ---------------------------------------------------
         START EXAM
      ----------------------------------------------------*/
      async function startStudentExam() {
        const snap = await getDocs(collection(db, "aptitude_questions"));
        let allQ = snap.docs.map((doc) => {
          const data = doc.data();
          return {
            id: doc.id,
            question: data.question,
            options: data.options,
            correct: Number(data.correct),
            selected: null,
          };
        });

        let currentQuestions = shuffleArray(allQ).slice(0, 25);
        currentQuestions.forEach((q) => {
          q.shuffledOptions = shuffleArray(
            q.options.map((o, i) => ({ option: o, index: i + 1 }))
          );
        });

        let currentIndex = 0;
        let remainingTime = 25 * 60;
        let timerInterval;

        function renderQuestion() {
          const form = document.getElementById("examForm");
          const q = currentQuestions[currentIndex];

          let html = `<b>Q${currentIndex + 1}:</b> ${q.question}<br><br>`;
          q.shuffledOptions.forEach((opt) => {
            const checked = q.selected === opt.index ? "checked" : "";
            html += `<label><input type="radio" name="q${currentIndex}" value="${opt.index}" ${checked}> ${opt.option}</label>`;
          });

          let nav = "";
          if (currentIndex > 0)
            nav += `<button type="button" onclick="prevQ()">Previous</button>`;
          if (currentIndex < currentQuestions.length - 1)
            nav += `<button type="button" onclick="nextQ()">Next</button>`;
          if (currentIndex === currentQuestions.length - 1)
            nav += `<button type="button" onclick="submitExam()">Submit Exam</button>`;

          form.innerHTML = html + nav;
        }

        function saveSelected() {
          const sel = document.querySelector(
            `input[name="q${currentIndex}"]:checked`
          );
          if (sel) currentQuestions[currentIndex].selected = Number(sel.value);
        }

        window.nextQ = () => {
          saveSelected();
          currentIndex++;
          renderQuestion();
        };

        window.prevQ = () => {
          saveSelected();
          currentIndex--;
          renderQuestion();
        };

        function updateTimer() {
          const m = Math.floor(remainingTime / 60);
          const s = remainingTime % 60;
          document.getElementById("timer").innerText = `${m
            .toString()
            .padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        }

        function startTimer() {
          updateTimer();
          timerInterval = setInterval(() => {
            remainingTime--;
            if (remainingTime <= 0) {
              clearInterval(timerInterval);
              submitExam();
            }
            updateTimer();
          }, 1000);
        }

        async function submitExam() {
          clearInterval(timerInterval);
          saveSelected();

          let score = 0;
          currentQuestions.forEach((q) => {
            if (q.selected && q.selected === q.correct) score++;
          });

          try {
            await addDoc(collection(db, "results"), {
              studentName: stuName,
              roll: stuRoll,
              loginId,
              testType: "Aptitude Test",
              score,
              total: currentQuestions.length,
              timestamp: new Date(),
            });

            document.getElementById("examForm").style.display = "none";
            document.getElementById("timer").style.display = "none";
            document.getElementById("msg").innerHTML = `
              <h3>Thank You for Completing the Exam!</h3>
              <p>Your Score: ${score}/${currentQuestions.length}</p>
            `;
          } catch (err) {
            console.error(err);
            alert("Failed to save results! Check Firebase rules.");
          }
        }

        window.submitExam = submitExam;

        renderQuestion();
        startTimer();
      }

      /* ---------------------------------------------------
         RUN DAILY CHECK â†’ THEN START EXAM
      ----------------------------------------------------*/
      checkDailyLimit().then((allowed) => {
        if (allowed) startStudentExam();
      });
    </script>
  </body>
</html>

