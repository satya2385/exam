<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin - Students</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 6px;
      }
      button {
        padding: 6px 12px;
        margin: 4px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background: #1565c0;
        color: #fff;
      }
      button:hover {
        background: #0d47a1;
      }
      button.deleteAll {
        background: #d32f2f;
      }
      input {
        padding: 6px;
        width: 250px;
        margin-bottom: 6px;
      }
    </style>
  </head>
  <body>
    <h2>Welcome, <span id="adminNameDisplay"></span></h2>
    <button onclick="logoutAdmin()">Logout</button>
    <hr />

    <h3>Add Student</h3>
    <input id="stuName" placeholder="Name" /><br />
    <input id="stuRoll" placeholder="Roll Number" /><br />
    <input id="stuLoginId" placeholder="Login ID" /><br />
    <input id="stuPassword" placeholder="Password" /><br />
    <button onclick="addStudent()">Add Student</button>
    <p id="stuMsg" style="color: green"></p>

    <h4>Upload Students (Excel)</h4>
    <input type="file" id="stuExcelFile" accept=".xlsx,.xls" />
    <button onclick="uploadStudentExcel()">Upload Excel</button><br /><br />
    <button class="deleteAll" onclick="deleteAllStudents()">
      ðŸ—‘ Delete All Students
    </button>

    <h4>Student List</h4>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Roll</th>
          <th>Login ID</th>
          <th>Password</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="studentTable"></tbody>
    </table>

    <script type="module">
      import { db } from "./firebase.js";
      import {
        collection,
        doc,
        setDoc,
        getDocs,
        deleteDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

      // Admin authentication
      const adminName = localStorage.getItem("adminName");
      if (!adminName) {
        alert("Login as admin!");
        window.location.href = "login.html";
      }
      document.getElementById("adminNameDisplay").innerText = adminName;
      window.logoutAdmin = () => {
        localStorage.clear();
        window.location.href = "login.html";
      };

      // Add Student
      window.addStudent = async () => {
        const name = document.getElementById("stuName").value.trim();
        const roll = document.getElementById("stuRoll").value.trim();
        const loginId = document.getElementById("stuLoginId").value.trim();
        const password = document.getElementById("stuPassword").value.trim();
        if (!name || !roll || !loginId || !password) {
          alert("Fill all fields!");
          return;
        }
        await setDoc(doc(db, "users", loginId), {
          name,
          roll,
          loginId,
          password,
          role: "student",
        });
        document.getElementById("stuMsg").innerText = "Student Added!";
        loadStudents();
      };

      // Load Students
      async function loadStudents() {
        const table = document.getElementById("studentTable");
        table.innerHTML = "";
        const snap = await getDocs(collection(db, "users"));
        snap.forEach((docu) => {
          const s = docu.data();
          if (s.role === "student") {
            table.innerHTML += `<tr>
        <td>${s.name}</td><td>${s.roll}</td><td>${s.loginId}</td><td>${s.password}</td>
        <td><button onclick="editStudent('${s.loginId}')">Edit</button></td>
        <td><button onclick="deleteStudent('${s.loginId}')">Delete</button></td>
      </tr>`;
          }
        });
      }
      loadStudents();

      // Edit Student
      window.editStudent = async (id) => {
        const newName = prompt("New name:");
        const newRoll = prompt("New roll:");
        const newPass = prompt("New password:");
        if (!newName || !newRoll || !newPass) return;
        await updateDoc(doc(db, "users", id), {
          name: newName,
          roll: newRoll,
          password: newPass,
        });
        loadStudents();
      };

      // Delete Student
      window.deleteStudent = async (id) => {
        if (!confirm("Delete this student?")) return;
        await deleteDoc(doc(db, "users", id));
        loadStudents();
      };

      // Delete All Students
      window.deleteAllStudents = async () => {
        if (!confirm("Delete ALL students?")) return;
        const snap = await getDocs(collection(db, "users"));
        for (let d of snap.docs) {
          if (d.data().role === "student")
            await deleteDoc(doc(db, "users", d.id));
        }
        alert("All students deleted!");
        loadStudents();
      };

      // Upload Excel
      window.uploadStudentExcel = async () => {
        const file = document.getElementById("stuExcelFile").files[0];
        if (!file) {
          alert("Select Excel file!");
          return;
        }
        const reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = async (e) => {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: "binary" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const excelData = XLSX.utils.sheet_to_json(sheet);
          for (let x of excelData) {
            if (x.LoginId && x.Name && x.Roll && x.Password) {
              await setDoc(doc(db, "users", x.LoginId), {
                name: x.Name,
                roll: x.Roll,
                loginId: x.LoginId,
                password: x.Password,
                role: "student",
              });
            }
          }
          alert("Students uploaded!");
          loadStudents();
        };
      };
    </script>
  </body>
</html>
